<div class="pet-detail-container" aria-busy="false">
  @if (isLoading()) {
  <div class="loading">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    <span>Loading pet...</span>
  </div>
  }

  @if (!isLoading() && !pet()) {
  <mat-card class="not-found">
    <mat-card-title>Pet not found</mat-card-title>
    <p>The pet you're looking for doesn't exist or has been removed.</p>
    <button mat-button routerLink="/home">Back to Home</button>
  </mat-card>
  }

  @if (pet()) {
  <mat-card class="summary-card">
    <mat-card-header>
      @if (pet()?.photoUrl) {
      <img mat-card-avatar [src]="pet()?.photoUrl" [alt]="pet()?.name" class="pet-avatar" />
      }
      @if (!isEditing()) {
        <mat-card-title>{{ pet()?.name }}</mat-card-title>
      }
      @if (!isEditing()) {
        <mat-card-subtitle>Species: {{ pet()?.species }}</mat-card-subtitle>
      }
      @if (isEditing()) {
        <mat-card-title>Editing: {{ pet()?.name }}</mat-card-title>
      }
    </mat-card-header>
    <mat-card-content>
      @if (!isEditing()) {
      <!-- View mode -->
      <div class="summary-grid">
        <div>
          <strong>Age:</strong>
          {{ calculateAge(pet()?.birthdate) }} years
        </div>
        <div>
          <strong>Birthday:</strong>
          {{ pet()?.birthdate | date: 'mediumDate' }}
        </div>
        <div><strong>Mode:</strong> {{ pet()?.mode }}</div>
      </div>
      @if (pet()?.description) {
      <div class="description-row">
        <strong>Description:</strong>
        <p>{{ pet()?.description }}</p>
      </div>
      }
      @if (isOwner()) {
      <div class="edit-actions">
        <button mat-raised-button color="primary" (click)="startEdit()">
          <mat-icon>edit</mat-icon>
          <span>Edit Pet</span>
        </button>
      </div>
      }
      }

      @if (isEditing()) {
      <!-- Edit mode -->
      <form [formGroup]="petForm" class="pet-edit-form">
        <mat-form-field appearance="outline">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" />
          @if (petForm.get('name')?.hasError('required')) {
          <mat-error>Name is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Species</mat-label>
          <mat-select formControlName="species">
            <mat-option value="Dog">Dog</mat-option>
            <mat-option value="Cat">Cat</mat-option>
            <mat-option value="Bird">Bird</mat-option>
            <mat-option value="Rabbit">Rabbit</mat-option>
            <mat-option value="Hamster">Hamster</mat-option>
            <mat-option value="Guinea Pig">Guinea Pig</mat-option>
            <mat-option value="Other">Other</mat-option>
          </mat-select>
          @if (petForm.get('species')?.hasError('required')) {
          <mat-error>Species is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Birthdate</mat-label>
          <input matInput [matDatepicker]="editPicker" formControlName="birthdate" />
          <mat-datepicker-toggle matIconSuffix [for]="editPicker"></mat-datepicker-toggle>
          <mat-datepicker #editPicker></mat-datepicker>
          @if (petForm.get('birthdate')?.hasError('required')) {
          <mat-error>Birthdate is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Visibility</mat-label>
          <mat-select formControlName="mode">
            <mat-option value="Public">Public</mat-option>
            <mat-option value="Private">Private</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" rows="3"></textarea>
        </mat-form-field>

        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="saveEdit()" [disabled]="petForm.invalid">
            <mat-icon>save</mat-icon>
            <span>Save</span>
          </button>
          <button mat-stroked-button (click)="cancelEdit()">
            <mat-icon>cancel</mat-icon>
            <span>Cancel</span>
          </button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>

  <mat-divider></mat-divider>

  <div class="flex-sections">
    <mat-card class="activities-card">
      <mat-card-header>
        <mat-card-title>Activities</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (isOwner()) {
        <form [formGroup]="activityForm" class="activity-form" (ngSubmit)="addActivity()">
          <mat-form-field appearance="outline">
            <mat-label>Type</mat-label>
            <input matInput formControlName="type" placeholder="e.g. Walk" required />
          </mat-form-field>
          <mat-form-field appearance="outline" class="notes-field">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" rows="2"></textarea>
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="activityForm.invalid">
            <mat-icon>add</mat-icon>
            <span>Add Activity</span>
          </button>
        </form>
        }

        @if (activities().length === 0) {
        <p class="empty">No activities yet.</p>
        }

        @if (activities().length > 0) {
        <table mat-table [dataSource]="activities()" class="mat-elevation-z1 activities-table">
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let act">
              {{ act.timestamp | date: 'shortDate' }}
            </td>
          </ng-container>
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let act">
              @if (isEditingActivity(act.id)) {
              <mat-form-field appearance="outline" class="edit-field" [formGroup]="getActivityEditForm(act.id)!">
                <input matInput formControlName="type" required />
              </mat-form-field>
              } @else {
              {{ act.type }}
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="notes">
            <th mat-header-cell *matHeaderCellDef>Notes</th>
            <td mat-cell *matCellDef="let act">
              @if (isEditingActivity(act.id)) {
              <mat-form-field appearance="outline" class="edit-field" [formGroup]="getActivityEditForm(act.id)!">
                <input matInput formControlName="notes" />
              </mat-form-field>
              } @else {
              {{ act.notes }}
              }
            </td>
          </ng-container>
          @if (isOwner()) {
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let act">
              @if (isEditingActivity(act.id)) {
              <button mat-icon-button color="primary" (click)="saveActivityEdit(act)" [disabled]="getActivityEditForm(act.id)?.invalid">
                <mat-icon>save</mat-icon>
              </button>
              <button mat-icon-button (click)="cancelEditActivity(act.id)">
                <mat-icon>cancel</mat-icon>
              </button>
              } @else {
              <button mat-icon-button (click)="startEditActivity(act)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteActivity(act)">
                <mat-icon>delete</mat-icon>
              </button>
              }
            </td>
          </ng-container>
          }
          <tr mat-header-row *matHeaderRowDef="actDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: actDisplayedColumns"></tr>
        </table>
        }
      </mat-card-content>
    </mat-card>

    <mat-card class="gallery-card">
      <mat-card-header>
        <mat-card-title>Image Gallery</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (isOwner()) {
        <div class="upload-control">
          <input type="file" multiple (change)="onFileSelected($event)" [disabled]="uploading()"
            aria-label="Upload images" />
          @if (uploading()) {
          <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
          }
        </div>
        }
        @if (gallery().length === 0) {
        <p class="empty">No images uploaded.</p>
        }
        @if (gallery().length > 0) {
        <div class="gallery-grid">
          @for (img of gallery(); track img.fullPath) {
          <div class="img-item">
            <img [src]="img.url" [alt]="pet()?.name + ' image'" />
            @if (isOwner()) {
            <div class="img-actions">
              <button mat-icon-button class="action-delete" color="warn" (click)="deleteImage(img)"
                aria-label="Delete image" title="Delete image">
                <mat-icon>delete</mat-icon>
              </button>
              <button mat-icon-button class="action-set-photo" color="primary" (click)="setAsPhoto(img)"
                aria-label="Set as profile photo" title="Set as profile photo">
                <mat-icon>photo</mat-icon>
              </button>
            </div>
            }
          </div>
          }
        </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
  }
</div>